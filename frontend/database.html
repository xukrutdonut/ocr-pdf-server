<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de Base de Datos - OCR PDF Server</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 300;
      font-size: 2.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .navigation {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .nav-button {
      background: white;
      color: #667eea;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .nav-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    
    .card-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-body {
      padding: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid #e9ecef;
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      border-bottom: 2px solid #e9ecef;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      font-size: 1rem;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }
    
    .tab:hover {
      color: #667eea;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .action-button {
      padding: 5px 10px;
      margin: 2px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }
    
    .action-button.edit {
      background: #667eea;
      color: white;
    }
    
    .action-button.delete {
      background: #dc3545;
      color: white;
    }
    
    .action-button:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .badge-percentil { background: #e7f3ff; color: #0066cc; }
    .badge-eneatipo { background: #fff3e0; color: #ff6f00; }
    .badge-decatipo { background: #f3e5f5; color: #7b1fa2; }
    .badge-wechsler { background: #e8f5e9; color: #2e7d32; }
    .badge-puntuacion_t { background: #fce4ec; color: #c2185b; }
    .badge-puntuacion_z { background: #e0f2f1; color: #00695c; }
    .badge-puntuacion_estandarizada { background: #fff8e1; color: #f57f17; }
    .badge-no_estandarizada { background: #ffebee; color: #c62828; }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
    }
    
    .close:hover {
      opacity: 0.7;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .button-primary {
      background: #667eea;
      color: white;
    }
    
    .button-secondary {
      background: #6c757d;
      color: white;
    }
    
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }
    
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      display: none;
    }
    
    .alert.show {
      display: block;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .refresh-button {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .refresh-button:hover {
      background: #667eea;
      color: white;
    }
    
    .confidence-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .confidence-bar {
      width: 60px;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffc107, #28a745);
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üóÑÔ∏è Editor de Base de Datos</h1>
    
    <div class="navigation">
      <a href="/" class="nav-button">‚¨ÖÔ∏è Volver a la P√°gina Principal</a>
    </div>
    
    <div id="alert" class="alert"></div>
    
    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <span>üìä</span>
          <span>Estad√≠sticas del Sistema</span>
        </div>
        <button class="refresh-button" onclick="loadData()">üîÑ Actualizar</button>
      </div>
      <div class="card-body">
        <div class="stats-grid" id="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="total-patterns">-</div>
            <div class="stat-label">Patrones Aprendidos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="total-feedback">-</div>
            <div class="stat-label">Retroalimentaciones</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="total-annotations">-</div>
            <div class="stat-label">Anotaciones</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="positive-feedback">-</div>
            <div class="stat-label">Feedback Positivo</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <span>üìù</span>
          <span>Datos de Aprendizaje</span>
        </div>
      </div>
      <div class="card-body">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('patterns')">Patrones</button>
          <button class="tab" onclick="switchTab('feedback')">Retroalimentaci√≥n</button>
          <button class="tab" onclick="switchTab('annotations')">Anotaciones</button>
        </div>
        
        <div id="patterns-tab" class="tab-content active">
          <div id="patterns-content" class="loading">Cargando...</div>
        </div>
        
        <div id="feedback-tab" class="tab-content">
          <div id="feedback-content" class="loading">Cargando...</div>
        </div>
        
        <div id="annotations-tab" class="tab-content">
          <div id="annotations-content" class="loading">Cargando...</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Pattern Modal -->
  <div id="edit-pattern-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Patr√≥n</h3>
        <button class="close" onclick="closeEditPatternModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Etiqueta:</label>
          <input type="text" id="edit-pattern-label">
        </div>
        <div class="form-group">
          <label>Tipo de Puntuaci√≥n:</label>
          <select id="edit-pattern-type">
            <option value="percentil">Percentil (0-100)</option>
            <option value="eneatipo">Eneatipo (1-9)</option>
            <option value="decatipo">Decatipo (1-10)</option>
            <option value="wechsler">Wechsler/CI (40-160)</option>
            <option value="puntuacion_t">Puntuaci√≥n T (20-80)</option>
            <option value="puntuacion_z">Puntuaci√≥n Z (-4 a +4)</option>
            <option value="puntuacion_estandarizada">Puntuaci√≥n Estandarizada PE (1-19, M=10, SD=3)</option>
            <option value="no_estandarizada">No es una puntuaci√≥n estandarizada</option>
          </select>
        </div>
        <div class="form-group">
          <label>Confianza:</label>
          <input type="number" id="edit-pattern-confidence" min="0">
        </div>
        <div class="form-group">
          <label>Puntuaci√≥n M√≠nima:</label>
          <input type="number" id="edit-pattern-min" step="0.1">
        </div>
        <div class="form-group">
          <label>Puntuaci√≥n M√°xima:</label>
          <input type="number" id="edit-pattern-max" step="0.1">
        </div>
      </div>
      <div class="modal-footer">
        <button class="button button-secondary" onclick="closeEditPatternModal()">Cancelar</button>
        <button class="button button-primary" onclick="savePattern()">Guardar</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Annotation Modal -->
  <div id="edit-annotation-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Anotaci√≥n</h3>
        <button class="close" onclick="closeEditAnnotationModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Texto Seleccionado:</label>
          <textarea id="edit-annotation-text" readonly></textarea>
        </div>
        <div class="form-group">
          <label>Nota:</label>
          <textarea id="edit-annotation-note"></textarea>
        </div>
        <div class="form-group">
          <label>Tipo de Puntuaci√≥n:</label>
          <select id="edit-annotation-type">
            <option value="">-- Ninguno --</option>
            <option value="percentil">Percentil (0-100)</option>
            <option value="eneatipo">Eneatipo (1-9)</option>
            <option value="decatipo">Decatipo (1-10)</option>
            <option value="wechsler">Wechsler/CI (40-160)</option>
            <option value="puntuacion_t">Puntuaci√≥n T (20-80)</option>
            <option value="puntuacion_z">Puntuaci√≥n Z (-4 a +4)</option>
            <option value="puntuacion_estandarizada">Puntuaci√≥n Estandarizada PE (1-19, M=10, SD=3)</option>
            <option value="no_estandarizada">No es una puntuaci√≥n estandarizada</option>
          </select>
        </div>
        <div class="form-group">
          <label>Abreviatura:</label>
          <input type="text" id="edit-annotation-abbr">
        </div>
      </div>
      <div class="modal-footer">
        <button class="button button-secondary" onclick="closeEditAnnotationModal()">Cancelar</button>
        <button class="button button-primary" onclick="saveAnnotation()">Guardar</button>
      </div>
    </div>
  </div>
  
  <script>
    let learningData = null;
    let currentEditIndex = -1;
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadData);
    
    async function loadData() {
      try {
        const response = await fetch('/get-learning-data');
        if (!response.ok) throw new Error('Error al cargar datos');
        
        learningData = await response.json();
        
        updateStats();
        renderPatterns();
        renderFeedback();
        renderAnnotations();
        
        showAlert('Datos cargados exitosamente', 'success');
      } catch (error) {
        showAlert('Error al cargar los datos: ' + error.message, 'error');
      }
    }
    
    function updateStats() {
      if (!learningData) return;
      
      document.getElementById('total-patterns').textContent = learningData.patterns?.length || 0;
      document.getElementById('total-feedback').textContent = learningData.feedback_history?.length || 0;
      document.getElementById('total-annotations').textContent = learningData.annotations?.length || 0;
      
      const positiveFeedback = learningData.feedback_history?.filter(f => f.is_correct).length || 0;
      document.getElementById('positive-feedback').textContent = positiveFeedback;
    }
    
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
    }
    
    function renderPatterns() {
      const container = document.getElementById('patterns-content');
      
      if (!learningData || !learningData.patterns || learningData.patterns.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No hay patrones aprendidos a√∫n</p></div>';
        return;
      }
      
      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>Etiqueta</th><th>Tipo</th><th>Confianza</th><th>Rango</th><th>Creado</th><th>Acciones</th>';
      html += '</tr></thead><tbody>';
      
      learningData.patterns.forEach((pattern, index) => {
        html += '<tr>';
        html += `<td><strong>${escapeHtml(pattern.label)}</strong></td>`;
        html += `<td><span class="badge badge-${pattern.score_type}">${pattern.score_type}</span></td>`;
        html += `<td><div class="confidence-indicator"><div class="confidence-bar"><div class="confidence-fill" style="width: ${Math.min(100, pattern.confidence * 20)}%"></div></div><span>${pattern.confidence}</span></div></td>`;
        html += `<td>${pattern.score_min?.toFixed(1) || '-'} - ${pattern.score_max?.toFixed(1) || '-'}</td>`;
        html += `<td>${formatDate(pattern.created)}</td>`;
        html += `<td>`;
        html += `<button class="action-button edit" onclick="editPattern(${index})">‚úèÔ∏è Editar</button>`;
        html += `<button class="action-button delete" onclick="deletePattern(${index})">üóëÔ∏è Eliminar</button>`;
        html += `</td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    function renderFeedback() {
      const container = document.getElementById('feedback-content');
      
      if (!learningData || !learningData.feedback_history || learningData.feedback_history.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No hay retroalimentaci√≥n registrada a√∫n</p></div>';
        return;
      }
      
      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>Fecha</th><th>Etiqueta</th><th>Puntuaci√≥n</th><th>Tipo Detectado</th><th>Correcto</th><th>Tipo Correcto</th><th>Acciones</th>';
      html += '</tr></thead><tbody>';
      
      learningData.feedback_history.slice().reverse().forEach((feedback, index) => {
        const actualIndex = learningData.feedback_history.length - 1 - index;
        html += '<tr>';
        html += `<td>${formatDate(feedback.timestamp)}</td>`;
        html += `<td>${escapeHtml(feedback.label)}</td>`;
        html += `<td>${feedback.score}</td>`;
        html += `<td><span class="badge badge-${feedback.detected_type}">${feedback.detected_type}</span></td>`;
        html += `<td>${feedback.is_correct ? '‚úÖ S√≠' : '‚ùå No'}</td>`;
        html += `<td>${feedback.correct_type ? `<span class="badge badge-${feedback.correct_type}">${feedback.correct_type}</span>` : '-'}</td>`;
        html += `<td><button class="action-button delete" onclick="deleteFeedback(${actualIndex})">üóëÔ∏è Eliminar</button></td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    function renderAnnotations() {
      const container = document.getElementById('annotations-content');
      
      if (!learningData || !learningData.annotations || learningData.annotations.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No hay anotaciones guardadas a√∫n</p></div>';
        return;
      }
      
      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>Fecha</th><th>Texto</th><th>Nota</th><th>Tipo</th><th>Abreviatura</th><th>Acciones</th>';
      html += '</tr></thead><tbody>';
      
      learningData.annotations.slice().reverse().forEach((annotation, index) => {
        const actualIndex = learningData.annotations.length - 1 - index;
        html += '<tr>';
        html += `<td>${formatDate(annotation.timestamp)}</td>`;
        html += `<td><div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(annotation.selected_text)}">${escapeHtml(annotation.selected_text)}</div></td>`;
        html += `<td><div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(annotation.note)}">${escapeHtml(annotation.note)}</div></td>`;
        html += `<td>${annotation.score_type ? `<span class="badge badge-${annotation.score_type}">${annotation.score_type}</span>` : '-'}</td>`;
        html += `<td>${annotation.abbreviation || '-'}</td>`;
        html += `<td>`;
        html += `<button class="action-button edit" onclick="editAnnotation(${actualIndex})">‚úèÔ∏è Editar</button>`;
        html += `<button class="action-button delete" onclick="deleteAnnotation(${actualIndex})">üóëÔ∏è Eliminar</button>`;
        html += `</td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    function editPattern(index) {
      currentEditIndex = index;
      const pattern = learningData.patterns[index];
      
      document.getElementById('edit-pattern-label').value = pattern.label;
      document.getElementById('edit-pattern-type').value = pattern.score_type;
      document.getElementById('edit-pattern-confidence').value = pattern.confidence;
      document.getElementById('edit-pattern-min').value = pattern.score_min || '';
      document.getElementById('edit-pattern-max').value = pattern.score_max || '';
      
      document.getElementById('edit-pattern-modal').style.display = 'block';
    }
    
    function closeEditPatternModal() {
      document.getElementById('edit-pattern-modal').style.display = 'none';
      currentEditIndex = -1;
    }
    
    async function savePattern() {
      if (currentEditIndex < 0) return;
      
      const pattern = learningData.patterns[currentEditIndex];
      pattern.label = document.getElementById('edit-pattern-label').value;
      pattern.score_type = document.getElementById('edit-pattern-type').value;
      pattern.confidence = parseInt(document.getElementById('edit-pattern-confidence').value);
      pattern.score_min = parseFloat(document.getElementById('edit-pattern-min').value) || 0;
      pattern.score_max = parseFloat(document.getElementById('edit-pattern-max').value) || 100;
      pattern.last_updated = new Date().toISOString();
      
      try {
        const response = await fetch('/update-learning-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(learningData)
        });
        
        if (!response.ok) throw new Error('Error al guardar');
        
        closeEditPatternModal();
        renderPatterns();
        showAlert('Patr√≥n actualizado exitosamente', 'success');
      } catch (error) {
        showAlert('Error al guardar: ' + error.message, 'error');
      }
    }
    
    async function deletePattern(index) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar este patr√≥n?')) return;
      
      learningData.patterns.splice(index, 1);
      
      try {
        const response = await fetch('/update-learning-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(learningData)
        });
        
        if (!response.ok) throw new Error('Error al eliminar');
        
        updateStats();
        renderPatterns();
        showAlert('Patr√≥n eliminado exitosamente', 'success');
      } catch (error) {
        showAlert('Error al eliminar: ' + error.message, 'error');
      }
    }
    
    async function deleteFeedback(index) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar esta retroalimentaci√≥n?')) return;
      
      learningData.feedback_history.splice(index, 1);
      
      try {
        const response = await fetch('/update-learning-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(learningData)
        });
        
        if (!response.ok) throw new Error('Error al eliminar');
        
        updateStats();
        renderFeedback();
        showAlert('Retroalimentaci√≥n eliminada exitosamente', 'success');
      } catch (error) {
        showAlert('Error al eliminar: ' + error.message, 'error');
      }
    }
    
    function editAnnotation(index) {
      currentEditIndex = index;
      const annotation = learningData.annotations[index];
      
      document.getElementById('edit-annotation-text').value = annotation.selected_text;
      document.getElementById('edit-annotation-note').value = annotation.note;
      document.getElementById('edit-annotation-type').value = annotation.score_type || '';
      document.getElementById('edit-annotation-abbr').value = annotation.abbreviation || '';
      
      document.getElementById('edit-annotation-modal').style.display = 'block';
    }
    
    function closeEditAnnotationModal() {
      document.getElementById('edit-annotation-modal').style.display = 'none';
      currentEditIndex = -1;
    }
    
    async function saveAnnotation() {
      if (currentEditIndex < 0) return;
      
      const annotation = learningData.annotations[currentEditIndex];
      annotation.note = document.getElementById('edit-annotation-note').value;
      annotation.score_type = document.getElementById('edit-annotation-type').value || null;
      annotation.abbreviation = document.getElementById('edit-annotation-abbr').value || null;
      
      try {
        const response = await fetch('/update-learning-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(learningData)
        });
        
        if (!response.ok) throw new Error('Error al guardar');
        
        closeEditAnnotationModal();
        renderAnnotations();
        showAlert('Anotaci√≥n actualizada exitosamente', 'success');
      } catch (error) {
        showAlert('Error al guardar: ' + error.message, 'error');
      }
    }
    
    async function deleteAnnotation(index) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar esta anotaci√≥n?')) return;
      
      learningData.annotations.splice(index, 1);
      
      try {
        const response = await fetch('/update-learning-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(learningData)
        });
        
        if (!response.ok) throw new Error('Error al eliminar');
        
        updateStats();
        renderAnnotations();
        showAlert('Anotaci√≥n eliminada exitosamente', 'success');
      } catch (error) {
        showAlert('Error al eliminar: ' + error.message, 'error');
      }
    }
    
    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = 'alert alert-' + type + ' show';
      
      setTimeout(() => {
        alert.classList.remove('show');
      }, 5000);
    }
    
    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString('es-ES', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }
  </script>
</body>
</html>
